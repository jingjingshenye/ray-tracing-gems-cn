Abstract

# Introduction

# Challenges Associated With Ray Tracing Large Scenes



# 27.3 视觉化方法（Visualization Methods）

在本节中，我们描述了几个简单但非常有用的、和光线追踪兼容的着色技术以及这些技术的实际应用场景和实现。使用可视化工具的科学家和技术人员们拥有丰富的领域专业知识，但是通常却对光学、照明、着色和计算机图形学技术只有普通的熟悉程度。这里描述的技术的一个关键部分就是它们易于被不是可视化专家的从业者使用，尤其是当这些技术是在一个带有渐进式的改造和其他细节的完全交互性光线追踪引擎中实现时。在科学可视化程序中已经有了众多优秀的基于光栅化的着色技术。然而，其中许多都依赖于光栅化特有的技术或者API功能，并且它们也可能和交互性光线追踪可视化引擎中常用的一系列光照和着色技术不兼容。接下来描述的技术具有低性能开销，可以与其他的光线追踪功能结合，并且最重要的是，已经在越来越多的实际的可视化产品中被使用。这里描述的光线追踪方法为环境光遮蔽照明、非真实感透明表面、不透明表面轮廓描边以及平面和球体裁剪提供了一些有用的科学可视化工具，且上述的每一项都有助于提高最终可视化的质量。





## 27.3.1 在科学可视化中的环境光遮蔽光照（AMBIENT OCCLUSION LIGHTING IN SCIENTIFIC VISUALIZATION ）

对于科学和技术可视化而言，环境光遮蔽（AO）光照的关键价值在于它能节省大量时间，特别是当它和复杂场景以及其他高保真光线追踪技术结合时。当用户通过持续的手动调整光线来实现预期的光照效果变得不切实际时，AO对于交互式的查看复杂的模型就显得很有用了，尤其是对于诸如模拟轨迹这样的时间序列数据。正是AO光照“ambient[1]”的一方面使得其成为了非专家用户的一个非常方便的工具。通过交互式使用AO和渐进式光线跟踪，用户不需要成为光照设计专家，就能通过调整一两个关键AO光照参数（通常会结合着一两个手动放置的平行光或点光源）达到一个良好的光源布置。在诸如分子可视化等领域，这点尤为明显，因为此时可视化光照设计只是单纯为了阐释分子结构的细节而不是去精确的重现出这些结构的真实场景。一个能让AO应用程序对初学者更加易用的方法是对于AO（环境光）和手动放置的（平行光）光源分别提供独立的光照比例因子。通过分别为环境光和平行光提供易于使用的全局强度比例因子，初学者便能更轻松的平衡他们的光照设计，避免了在包含口袋、小孔/隧道或孔洞等造成光照问题的几何复杂场景中过度光照或过少光照的问题。

[^1 译者注]: ambient可指环境，也能形容产生轻松氛围的东西，这里是双关，意为表现AO的易于使用。



### 27.3.1.1 有限遮蔽距离的AO（AO WITH LIMITED OCCLUSION DISTANCE ）

在探索包含密集几何体的场景时，一个AO经常出现的问题是，对于类似病毒衣壳或细胞膜这种复杂结构体，少有路径能允许环境光深入其中。对于这个问题的一个简单但有效的解决方法是用一个最大遮蔽距离来计算AO光照，超过这个距离的则被忽视。当使用这个技术时，可以选择一个恰当的最大遮蔽距离，使得能够毫无问题的与限定的目标观察空间相适应，并保持AO对于可视化目的的关键优势， 如图27-2所示。虽然摄像机中心的点光源能够被用来照亮几乎或完全封闭的结构体阴暗内部，但它也会导致不受欢迎的扁平外观的表面。这个问题也能通过仔细地手动或偏移多个点光源或区域光源的放置解决，但是这样的工作终归是对于无限制交互式探索复杂模型和模拟结果的讨厌干扰。使用有限遮蔽距离的AO就能在避免这些讨厌的问题的同时保证不受限的交互场景浏览。这种方式一个另外的----也许是出乎意料的----好处是最大AO遮蔽距离也能被用于仅对小孔，口袋和指定最大直径的孔洞做阴影处理，使得AO光照变成了一种能有一定程度选择性地高亮特定几何体特征的工具。如果有需要，这项技术也能与用户指定的AO 衰减系数结合来进一步优化。清单27-2给出了一个简单的实现。



图27-2 不同AO光照最大遮蔽距离设置下HIV-1衣壳内部的可视化结果。(a)传统的AO光照：因为病毒的衣壳完全封闭了观察点，只有少量几束稀薄的的光线通过衣壳结构上的小孔进入了内部，导致几乎全黑的结果。(b)用户指定的最大遮蔽距离被设置为略小于衣壳的**小内径**。剩下的图像分别展示了当距离被因子(c) 2, (d) 8, 和(e) 16 减少时的结果。



**Warning!** Listing 27-2 原书印刷有误，联系了作者，正确的应该是如下的英文：

> This short closest-hit shader code snippet implements ambient occlusion (AO) lighting with a limited occlusion distance, permitting AO lighting to be used within confined or fully enclosed spaces that would otherwise result in 100% occlusion and full shadow.

清单27-2 下面简短的closest-hit shader代码实现了有限遮蔽距离的AO光照。它允许AO光照被用于狭小或完全封闭的空间，不然它们会导致100%的遮蔽和全阴影。

```c
// Final shaded surface color
// 最后着色的表面颜色

// max AO occluder distance
// 最大AO遮蔽距离

// Skipping boilerplate AO shadowing material here
// 跳过AO阴影材质的样板代码

// Skipping boilerplate AO shadowing material here
// 跳过AO阴影材质的样板代码

// Skipping boilerplate closest-hit shader material here
// 跳过closest-hit shader材质的样板代码

// Add ambient occlusion diffuse lighting, if enabled.
// 如果开启，则添加AO漫反射光照

// Continue with typical closest-hit shader contents
// 继续执行典型的closest-hit shader内容

// Pass the resulting color back up the tree.
// 记录最后的颜色
```





### 27.3.1.2 降低蒙特卡洛采样噪点（REDUCING MONTE CARLO SAMPLING NOISE ）

使用可视化工具的科学家们经常需要快速地生成“快照”渲染作为团队会议和展示上的日常使用。由于时间总是很短， 用户倾向于使用高保真度的渲染方式，但前提是渲染能在任何时刻停止，为他们提供没有“颗粒”和“斑点”的渲染图像，即使渲染结果光照或景深焦距模糊并没有完全收敛也没关系。一类尤其有前景的业界最新的实时降噪技术是通过采用仔细训练好的深度神经网络来消除蒙特卡洛渲染生成的图像中欠采样的区域中的噪点。这种所谓的人工智能（AI）降噪器的成功，通常依赖于辅助图像数据缓冲的有效性。这些缓冲中包含了深度，表面法线，反射率以及其他能够帮助降噪器更好识别噪点和欠采样图像区域的信息。交互级别性能的AI降噪器也依赖于硬件加速的AI推断能力，这种能力能使得AI降噪器比暴力采样有更好的性能，即使是在拥有专用光线追踪硬件加速的硬件平台上也是如此。在复杂的路径追踪和更通用的光线追踪引擎中，AI降噪看起来仍然将会是最好也是最广泛使用的降噪方式之一，因为这项技术可以为特定的渲染器和场景内容进行专门的调优和训练。



除了复杂的降噪技术，也可以在高频噪声内容和随机样本相关性之间进行潜在有益的权衡，比如在次采样的交互式渲染中产生可见的AO阴影边界边缘。在传统的光线追踪技术中，AO光照和其他蒙特卡罗采样实现通常使用完全不相关的伪随机数或准随机数序列来生成垂直于被遮蔽表面的半球内的AO光照阴影探测器射线的方向。使用不相关的采样方法，当采集到足够数量的AO光照样本时，就能产生平滑的无颗粒图像。然而，提早终止一个未收敛的采样过程会生成像颗粒状的图像。通过故意将所有图像像素中的AO样本关联起来，例如，通过设置AO随机数生成器或准随机序列生成器为同一个随机种子，图像中所有的像素都会选择同样的AO阴影探测器方向，将不会有来自AO的图像颗粒。这种方法特别适用于几何复杂场景的交互式光线追踪，否则需要大量采样才能获得无颗粒图像。





## 27.3.2 透明表面的边缘强化（EDGE-ENHANCED TRANSPARENT SURFACES ）

一个在分子可视化中出现的常见问题是需要清楚地显示分子复合物或其组成子结构的边界，同时使其易于查看其内部结构的细节。分子科学家们花费了大量的努力来选择什么应该被显示以及应该被怎样显示。Raster3D [11], Tachyon [18], and VMD [5, 20] 使用了特殊的着色器，通过让观察者这一面的表面完全透明同时让被看到的边界区域基本不透明，使其更容易看到结构的内部。表面着色器可立即适应观察方向的变化，允许用户自由旋转分子复合物，同时保持内部细节的清晰视野。这项技术在图27-3中有效地演示出来，其中它被应用于捕光复合物和光合作用反应中心，在图27-4中，它被应用于溶剂盒和溶剂/蛋白质交界处。通过查看清单27-3来了解着色器实现的具体细节。



图27-3 对于细胞内部利用光合作用生成ATP（三磷酸腺苷，被称为活细胞的化学燃料）的载色体[1]捕光囊泡的可视化。前景载色体囊泡显示了透明的分子表面，以揭示其各个光合复合物和反应中心内的叶绿素色素环的选定内部原子结构。不透明的载色体背景实例显示了在一只紫细菌的细胞质内的密集的载色体囊泡。



图27-4 一个展开的锚蛋白的分子动力学可视化。这里使用了透明表面的边缘强化技术来渲染溶剂（水和离子）表面。



清单 27-3 这段例代码段使面向观察者的表面看起来完全透明，同时使表面能被看到的边缘更加可见和不透明。 这种类型的渲染对于促进拥挤场景内部的视图极其有用，例如密集的生物分子复合物。

```c
// Skipping boilerplate closest-hit shader material here
// 跳过closest-hit shader材质的样板代码

// Exemplary simplified placeholder for typical
// transmission ray launch code
// 典型传输光线发射代码的示例占位

// Emulate Tachyon/Raster3D's angle-dependent surface opacity
// 模拟Tachyon/Raster3D的角度相关的表面不透明度

// Scale down lighting by any new transparency
// 使用新的透明度来调整光照

// Skipping boilerplate code to prepare a new transmission ray
// 跳过准备传输光线的样板代码

// Continue with typical closest-hit shader contents
// 继续执行典型的closest-hit shader内容

// Pass the resulting color back up the tree.
// 记录最后的颜色
```





[^1 载色体]: http://terms.naer.edu.tw/detail/3178253/







## 27.3.3 剔除过多的透明表面（PEELING AWAY EXCESS TRANSPARENT SURFACES ）



科学可视化中的许多领域产生了包含大量部分透明几何体的场景，这些几何体通常用来显示在不同类型的体积数据中的表面，例如电子密度图，医学图像，来自低温电子显微镜的断层图像，或来自计算机流体动力学模拟的流场。当渲染场景包含复杂或者有噪声的体积数据时，透明的等值面以及其包含的几何体可能变得难以可视化展示，对此，一个通常很有用的做法是故意采用非真实感的渲染，把除了第一层或前面几层的透明表面以外的表面都剔除掉，这样它们就不会在我们所关注的特征后面产生干扰的背景。如图27-5所示。可以通过对经典的closest-hit shader做一点小改动来实现上述的透明表面剔除：在每个光线的数据中，为透明表面相交存储一个额外的计数器。当主光线生成时，相交计数器被初始为需要显示的透明表面的最大数量。当光线在场景中追踪时，每当与透明表面相交则将此计数器减一，直到其变成零。一旦发生计数器变为零，之后所有与透明表面的相交都将被忽略，也就是说，它们不会被着色，也不会对最终的颜色有贡献。同时传输光线被生成并继续追踪，就好像这里并没有发生相交一般。清单27-4显示了一个示例实现。





图27-5 兔出血病毒原子结构的特写可视化。通过X射线晶体学和计算机建模并使用MDFF(molecular dynamics flexible fitting, 分子动力学柔性拟合)从低温电子显微镜拟合成低分辨率电子密度图：（左）传统光线追踪透明度的结果，（右）使用了透明表面剔除方法来减少对拟合内部原子结构的细节遮挡后的结果。





清单27-4 当入射光线穿过了用户指定的最大数量的透明表面时，这个closest-hit shader代码片段会跳过着色透明表面，取而代之的是发射一个传输光线并继续执行，就好像这里并未发生光线和表面的相交一般。









## 27.3.4 轮廓描边（EDGE OUTLINES ）

对不透明物体加上轮廓描边，通常有助于使同样颜色的相近物体或表面的深度和空间关系更加明显，使用户更容易解读。轮廓描边既可以用来增强诸如突起，微孔或口袋等表面结构突出细节的可见性，也可以用来实现细节渲染时的光照效果或者在景深模糊效果时保持细节。图27-6展示了分别将轮廓描边应用在结合了景深模糊的结构的前景和背景时的效果。



图27-6 结合了景深模糊并应用了轮廓描边来加强结构特征可见性的分子表面的可视化。上图：轮廓描边仅被较少的使用，且仅在被聚焦的前景分子表面才能容易看到。下图：轮廓描边宽度被显著增加。虽然加宽的轮廓描边对于被聚焦的前景结构来说可能显得过度了，但是它能让即使在被模糊和褪色的最远结构中的分子结构突出的细节也被看到。



虽然传统光栅化流水线中存在很多轮廓描边技术，但它们通常以多遍渲染方法实现，这些方法通常需要访问深度缓冲器，而这不适合大多数光线追踪引擎的内部工作。多年来，VMD和Tachyon已经实现了一个易于使用的轮廓着色器，它在光线追踪引擎中很容易实现，因为它不需要访问深度缓冲区，延迟着色或其他额外的渲染过程。清单27-5展示了一个示例实现。

清单 27-5 这个示例代码在几何体边缘添加深色的描边来突出挤在一起的物体。没有轮廓描边这些物体可能很难被清楚地看到。

```c
// Final shaded surface color
// 最后着色的表面颜色

// Example of instantiating a shader with outlining enabled
// 实例化一个打开描边的shader示例

// Skipping boilerplate closest-hit shader material here 
// 跳过closest-hit shader材质的样板代码

// Add edge shading, if applicable
// 如果满足条件，执行描边

// Continue with typical closest -hit shader contents
// 继续执行典型的closest-hit shader内容

// Pass the resulting color back up the tree.
// 记录最后的颜色
```





## 27.3.5 裁剪平面和球体（CLIPPING PLANES AND SPHERES ）

构造实体几何（ Constructive solid geometry，缩写为 CSG）是高级光线追踪引擎用户们长期以来一直很喜欢的一项强大渲染功能。它通过对任意数量的基本几何图元进行并集，交集，补集操作来建模复杂的几何体[14]。CSG可以成为建模复杂形状的强力工具，但是在科学可视化中，用户经常需要易于使用的工具来去掉视觉上的遮挡物，而这正好可以通过CSG补集操作来完成。当交互式的可视化大型场景时，要在不影响帧速率的同时去大幅度修改场景下模型或数据往往不太现实。然而，在这样的约束下，不更改模型反而去操作底层渲染过程的方法往往是可行的。完全通用的CSG实现需要不少的簿记信息，但裁剪几何体是一种可以更简单实现特殊情况。由于光线追踪引擎通过对相交的计算和排序来完成其工作，因此通常很容易在相交管理逻辑中实现用户定义的剪切平面，球体或其他剪切几何体。当裁剪几何体全局地应用于场景中所有事物时，情况尤其如此，因为这种情况下只会产生微不足道的簿记开销。全局剪裁几何体通常可以通过计算剪裁几何体的相交距离并将其存储在每个光线的数据中，以便在渲染场景的其他几何体时使用，从而添加到任何光线追踪引擎中。 清单27-6展示了一个示例实现。



清单27-6 摘录自Tachyon的这段代码显示了实现一个基本的用户定义的裁剪平面功能（当打开此功能时，会全局的裁剪所有的对象）有多简单。这是通过在每个光线数据中存储裁剪平面信息，并为每一个要测试的裁剪平面添加一个简单的距离比较来实现的。

```c
/* Only keeps closest intersection, no clipping, no CSG */
// 只保存最近的相交，没有裁剪，没有CSG

/* if we hit something before maxdist update maxdist */
// 如果我们在最大距离前发生了相交，更新最大距离

/* Only keeps closest intersection, also handles clipping, no CSG */
// 只保存最近的相交，同时处理裁剪，没有CSG

/* handle clipped object tests */
// 处理裁剪对象测试

/* find hit point for further tests */
// 为了后续测试寻找相交点

/* hit point was clipped */
// 相交点已被裁剪

/* Only meant for shadow rays, unsafe for anything else */
// 只适用于阴影光线，不适用于其他

/* if this object doesn't cast a shadow, and we aren't */
/* limiting the number of transparent surfaces to less */
/* than 5, then modulate the light by its opacity value */
// 如果这个物体并不投射阴影且我们没有限制透明表面的数量需要小于5，那么对光照取这个物体透明度的模

/* if we hit *anything* before maxdist, and we're firing a */
/* shadow ray, then we are finished ray tracing the shadow */
// 如果我们在最大距离前发生了相交，我们生成一个阴影射线，接着我们就完成了阴影的光线追踪

/* Only meant for clipped shadow rays, unsafe for anything else */
// 只适用于裁剪阴影光线，不适用于其他
```







# 27.4 结尾的思考（Closing Thoughts）

本章描述了使用交互式光线追踪技术进行科学可视化的许多益处和挑战。由于光线追踪的主要优势众所周知，本章包含了一些非常规技术，将非真实感方法与光线追踪的经典优势相结合，以解决棘手的可视化问题。虽然给出的大多数示例图像和动机都是自然界中的生物分子，但这些方法在许多其他领域也有价值。我自己和其他人研究的一个令人激动的领域就是使用诸如交互式路径追踪等技术进行科学可视化的持续发展。对于科学家可能每天执行的许多常规可视化任务而言，路径追踪曾经开销太大以至于不实用。然而，当最先进硬件提供的光线追踪性能与蒙特卡罗图像去噪最新技术相结合时，交互式路径追踪已经能够胜任许多可视化工作而无需牺牲交互性或图像质量。这些发展对于科学和技术可视化具有特别的价值，因为对它们而言提升图像真实感很重要。



本章中的示例代码都只是为了进一步专业化的示范性起点。每种技术都可以被极大地扩展，增加远远超出这里所展示的新功能，而我试图在简单性，可重用性和完整性之间取得平衡。





# 鸣谢

本项工作部分由国家卫生研究院在P41-GM104601授权下支持。作者为载色体模型的使用感谢Melih Sener和Angela Barragan。作者希望感谢伊利诺伊大学理论与计算生物物理学小组的许多现任和前任同事多年来就VMD分子可视化软件的设计和使用先进的渲染技术进行有效可视化生成的合作。





