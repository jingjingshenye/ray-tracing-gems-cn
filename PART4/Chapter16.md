# 16.5 均匀采样表面

当均匀地采样二维表面，也就是表面上的每个点被采样的可能性相同时，每个点的概率密度函数都等于一除以表面积。例如，对于单位球体而言$p=1/4π$。

## 16.5.1 碟

一个碟（状几何体）以原点${(x,y)=(0,0)}$为中心，半径为$r$。

### 16.5.1.1 极坐标映射

*极坐标映射*将输入$u[0]$转换为更大的半径，从而确保样本的均匀分布。碟的面积随着半径的增加而增加，只有四分之一在半径的一半的范围内。
```
r = R * sqrt(u[0]);
phi = 2*M_PI*u[1];
x = r*cos(phi);
y = r*sin(phi);
```

由于“接缝”（逆变换中的不连续性）的存在，通常不使用极坐标映射，除了不能使用条件分支的情况，都优先使用下面讨论的同心映射。

### 16.5.1.2 同心映射

*同心映射*将$[0,1)^{2}$的同心正方形映射到同心圆，这样就避免了接缝和相邻性问题[11]。

```
a = 2*u[0] - 1;
b = 2*u[1] - 1;
if (a*a > b*b) {
    r = R*a;
    phi = (M_PI/4)*(b/a);
} else {
    r = R*b;
    phi = (M_PI/2) - (M_PI/4)*(a/b);
}
X = r*cos(phi);
Y = r*sin(phi);
```

## 16.5.2 三角形

为了均匀地采样具有顶点$P_{0}$，$P_{1}$和$P_{2}$的三角形，我们使用重心坐标系将坐标变换到范围内，如果种子点不在方形的下半部分，则翻转种子点。

### 16.5.2.1 变形
通过将四边形扭曲成三角形，我们可以直接在有效的重心坐标范围内采样：
```
beta = 1-sqrt(u[0]);
gamma = (1-beta)*u[1];
alpha = 1-beta-gamma;
P = alpha*P0 + beta*P1 + gamma*P2;
```

### 16.5.2.2 翻转
为了避免计算平方根，你还可以从四边形进行采样。在这种情况下，如果发现样本处于对角线的错误一侧，则需要翻转样本点。由于通常无法保持翻转时两维点的良好分布，这会降低三角形内蓝噪声或低差异采样的有效性。
```
alpha = u[0];
beta = u[1];
if (alpha + beta > 1) {
    alpha = 1-alpha;
    beta = 1-beta;
}
gamma = 1-beta-alpha;
P = alpha*P0 + beta*P1 + gamma*P2;
```

## 16.5.3 三角形网格
为了对三角形网格上的点进行采样，Turk[13]建议在三角形区域的一维离散分布上使用二分搜索。

我们可以通过组合第16.4.2.2节中的纹理采样，第16.5.2节中的三角形采样，以及从第16.3.4.2节中的数组采样函数中得到的重映射的均匀分布样本，来改进网格采样并创建从单位正方形到网格的映射，步骤如下：
* 将每个三角形的面积存储在方形二维表中。顺序无关紧要。使用0作为与任何三角形都无关的单元格的面积。
* 为表中的每一行构建面积的累积分布函数并进行标准化。
* 为最后一列（每行的面积之和）构建面积的累积分布函数并进行标准化。

对网格进行采样的步骤如下：
* 采用均匀分布的二维样本$(u[0],u[1])$。
* 使用$u[1]$二分搜索列累积分布函数。这决定了使用哪一行$r$。
* 使用$u[0]$二分搜索行以查找样本的列$c$。
* 将重新映射的样本$(u[0],u[1])$保存为$(v[0],v[1])$。
* 使用我们重新映射的二维变量$(v[0],v[1])$，通过第16.5.2节中的三角形采样方法对与行$r$和列$c$对应的三角形进行采样。
* 得到的三维坐标均匀分布在三角形网格上。

请注意，此方法是不连续的，这可能会影响转换后采样的质量。

## 16.5.4 球
球体以原点为中心，半径为$r$。

### 16.5.4.1 纬度-经度映射
以下代码展示了如何使用统一的*纬度-经度映射*生成采样点。注意，$z$值均匀分布在$(-1,1]$上。
```
a = 1 - 2*u[0];
b = sqrt(1 - a*a);
phi = 2*M_PI*u[1];
x = R*b*cos(phi);
y = R*b*sin(phi);
z = R*a;
```

### 16.5.4.2 八面体同心(均匀)映射
之前的方法（纬度-经度映射）是直观的，但有个缺点是它在顶部和底部会非常显著地“拉伸”采样域。使用16.5.1.2节中的同心映射并将其与八面体映射（参见Praun和Hoppe[9]图2）相结合，可以定义具有良好特性的球体的*八面体同心映射*，它的伸展率在最差的情况下是2：1 [1]。使用均匀的二维点作为输入，到单位球体的更好的变换如下：

```
// 计算半径r(没有条件分支)。
u = 2*u - 1;
d = 1 - (abs(u[0]) + abs(u[1]));
r = 1 - abs(d);

// 计算第一象限中的phi（除了除零测试以外没有条件分支），
// 使用sign(u)将结果映射到下面的正确象限。
phi = (r == 0) ? 0 : (M_PI/4) * ((abs(u[1]) - abs(u[0])) / r + 1);
f = r * sqrt(2 - r*r);
x = f * sign(u[0]) * cos(phi);
y = f * sign(u[1]) * sin(phi);
z = sign(d) * (1 - r*r);
pdf = 1 / (4*M_PI);
```

请注意，在许多应用中，这些从单位正方形到单位球的变换不仅可用于生成样本，还可用于在二维域中方便地表示球面函数。这对于将单位球面上的点（例如，射线方向）映射回二维的逆操作也同样有用。

# 16.6 采样方向
在球体或半球的方向上定义的采样概率密度函数是许多光线追踪器的核心部分。这种采样通常用于求入射光以计算某一点的出射强度的积分。这些概率密度函数通常以球坐标定义，其中极角（有时被称为*天顶角*）通常表示为$θ$，方位角表示为$φ$。不幸的是，不同的领域使用不同的符号约定，有时和前述的定义完全相反。因此，取决于读者的知识背景，这种符号约定可能与他们的习惯相反，但它在计算机图形学中是相对标准的。

选择方向时，常见的惯例是在单位球体（或半球）上选择一个点，并将方向定义为从球心到该点的单位矢量。

## 16.6.1 Z轴向余弦加权半球
在渲染粗糙表面时，生成漫反射光线的常用方法是使用碟状采样生成采样点（如第16.5.1节），然后将采样点投影到半球。这样做会产生具有*余弦加权分布*的样本，其分布密度在半球的顶点处高，底部低。生成的样本需要转换为正在渲染的曲面的局部切线空间。
```
x = sqrt(u[0])*cos(2*M_PI*u[1]);
y = sqrt(u[0])*sin(2*M_PI*u[1]);
z = sqrt(1-u[0]);
pdf = z / M_PI;
```

## 16.6.2 矢量轴向余弦加权半球
作为将$z$轴变换为$n$（例如，切线空间的法线）的替代方案，我们可以在切线球上使用均匀分布的样本。这种方法避免了构造切向量，但这是以降低边界条件下的数值精度为代价的。我们可以通过在球体表面上连接两个均匀分布的样本来选择均匀分布的球体方向[10]。这样做意味着到第二点的方向具有相对于第一点的余弦密度。如果向量$n =(n_{x},n_{y},n_{z})$是单位长度向量，则表示如下：
```
a = 1 - 2*u[0];
b = sqrt(1 - a*a);
phi = 2*M_PI*u[1];
x = n_x + b*cos(phi);
y = n_y + b*sin(phi);
z = n_z + a;
pdf = a / M_PI;
```
注意，$(x,y,z)$不是单位矢量。因此当切线球上的均匀分布的样本几乎与$n$相反时会出现精度问题，导致输出矢量接近零。这些点对应于掠射射线（垂直于法线）。为了避免这些情况，我们可以通过将$a$和$b$乘以略小于$1$的数字来缩小切线球。

## 16.6.3 椎体方向
给定以$z$轴正向为轴，扩展角为$θ_{max}$的锥体，锥体中的均匀方向可用如下方式采样：
```
float cosTheta = (1- u[0]) + u[0] * cosThetaMax;
float sinTheta = sqrt(1 - cosTheta * cosTheta);
float phi = u[1] * 2 * M_PI;
x = cos(phi) * sinTheta;
y = sin(phi) * sinTheta;
z = cosTheta; （译注：原书此处三行缺少分号）
```
所有样本的概率密度函数均为 $1/(2π(1 − cos θ_{max}))$。

## 16.6.4 PHONG分布
给定具有参数s的类似Phong的概率密度函数，

$$formula 11$$

我们可以相对于z轴方向进行采样，如下所示：
```
cosTheta = pow(1 - u[0],1 / (1 + s));
sinTheta = sqrt(1 - cosTheta * cosTheta);
phi = 2 * M_PI * u[1];
x = cos(phi) * sinTheta;
y = sin(phi) * sinTheta;
z = cosTheta;
```
注意，生成的方向可能低于图中指示的表面。大多数程序检测这种情况并将这些方向的贡献设置为零。

## 16.6.5 GGX分布
Trowbridge-Reitz GGX法线分布函数[12, 15]：
$$formula 12$$
它通常被用于计算微表面反射模型中的高光分量。其宽度或*粗糙度*参数$α$定义了表面的外观，较低的值表示较亮的表面。

可以通过将二维均匀分布的样本变换为半矢量的球坐标来对GGX分布进行采样：
$$formula 13$$
$$formula 14$$
其中$α$是GGX粗糙度参数。使用三角恒等式重写表达式可以很方便地计算出$cosθh$：
$$formula 15$$
接着同样使用毕达哥拉斯三角恒等式来计算$\sin{θ_{h}}=\sqrt{1-\cos^{2}{θ_{h}}}$。样本半矢量的概率密度函数是$p(θ_{h},φ_{h})=D(θ_{h})\cos{θ_{h}}$。

对于渲染，我们通常感兴趣的是基于给定的出射方向和局部切标架对入射方向进行采样。为此，将出射方向$\hat{v}$在采样的半矢量$\hat{h}$周围反射，求得入射方向$\hat{l}=2(\hat{v} \cdot \hat{h})\hat{h}-\hat{v}$。这会更改上面的概率密度函数，必须乘以变换的雅可比行列式$1/(4(\hat{v} \cdot \hat{h}))$[14]。

与第16.6.4节中的Phong采样一样，生成的方向可以低于曲面。通常这些是被积函数为零的区域，但程序员应该确保小心处理这些情况。

# 16.7 体积散射
对于体积，通常也称为*参与介质*，光线将以概率方式与体积“碰撞”。有些程序通过增量*光线积分*来实现这一点，另一种方法是计算离散碰撞。有关体积的更多信息，请参阅Pharr等人[8]的第11章。

有关该主题的更多信息，请参见第28章。

## 16.7.1 体积中的距离
通过散射和吸收介质追踪光子需要对与体积透射率成比例的距离进行重要性采样
$$formula 16$$
对于体积消光系数$κ(t)$。此分布的概率密度函数是
$$formula 17$$

### 16.7.1.1 均匀介质
在$κ$是常数的情况下，我们有$p(s)=κexp(-sκ)$，反演得到：
```
s = -log(1 - u) / kappa;
```
注意$1-u$很重要：由于我们假设$u∈[0,1)$，所以$1-u∈(0,1)$，这可以避免计算零的对数！

### 16.7.1.2 非均匀介质
对于在空间中变化的$κ(t)$，通常被称为*Woodcock跟踪*的程序可以给出期望的分布[16]。给定沿光线的最大消光系数$κ_{max}$和在$[0,1)$范围内的样本生成器$u$，程序如下：
```
s = 0;
do {
    s -= log(1- u()) / kappa_max;
} while (kappa(s) < u() * kappa_max);
```
## 16.7.2 HENYEY-GREENSTEIN相函数

*Henyey-Greenstein相函数*是模拟体积内定向散射特征的有用工具。它是一个在整个球体方向上的概率密度函数，它的值仅取决于输入和输出方向之间的角度$θ$，并且由单个参数$g$（平均余弦）控制：

$$formula 18$$

对于$g = 0$，散射是各向同性的，对于接近$-1$的$g$，散射变为高度聚焦的前向散射，对于接近$1$的$g$，散射变成高度聚焦的后向散射。
```
phi = 2.0 * M_PI * u[0];
if (g != 0) {
    tmp = (1 - g * g) / (1 + g * (1 - 2 * u[1]));
    cos_theta = (1 + g * g - tmp * tmp) / (2 * g);
} else {
    cos_theta = 1 - 2 * u[1];
}
```

## 16.8 添加到“动物园”
本文展示了许多对光线追踪程序有用的映射。但我们还没有深入探讨(将新的映射)添加到这个系列中所需的理论。想要更多地了解该理论以便可以自己添加“动物”的读者可以在Pharr[8]，Glassner [5]和Dutré[4]等人的书中找到完整的方法。