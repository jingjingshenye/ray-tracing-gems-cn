# Chapter 15  重要性采样
摘要：

随着近来的光线追踪技术应用到实时图形渲染管线，开发者面临着新的挑战：如何充分利用所能追踪的每一条光线。有两个关键问题需要开发者的判断。其一，光线追踪究竟要达到怎样的光照效果——例如阴影，反射，环境光遮蔽和全局光照。

其二，在选定光照效果以后，选择*哪些*光线去追踪；本章的主题就是介绍该问题的答案。在接下来的篇幅中，读者将会看到，渲染的光照计算如何被描述成估计积分值，以及光线追踪是如何天然地与蒙特卡洛数学积分方法结合起来。首先给出蒙特卡洛积分的数学背景，然后读者会了解到经过挑选的采样光线如何显著地提高着色器像的收敛速度，改善整个渲染系统的性能。通过该方法，可以利用更少的光线达到同样的渲染质量，或者采样同样多的光线，生成质量更好的误差更小的图像。
## 15.1	概述
2018年的游戏开发者大会发布了DirectX Raytracing(DXR)技术，同年夏天发布了NVIDIA的RTX GPU，光线追踪由此成为了实时渲染的手段之一。这是实时图形渲染管线方面的最伟大进展之一。曾经光栅化是唯一用于可视化的算法，现在第二条路出现了——光线追踪。

光线追踪和光栅化可以互为补充。光栅化仍然是高效率地获取直接的可视化计算的方法：它假定一个观查点（对于一个正交的视角，只有一个观察点），定期对像素网格上的可见性做采样。光栅化的性质有利于把大量像素的三角形计算，高性能地硬件实现分摊，从而逐步计算像素分布的深度和范围。

形成对比的是，光线允许不连贯的可视化计算。每条光线可以采用任意的起点和方向；硬件对此并无限制。

开发者需要学会更好地利用光线追踪。GPU的光线追踪硬件向开发者提出了几个可视化的问题：“一点沿当前方向出发看到的第一个物体是什么？”“观察点和物体点之间是否存在阻挡？”对于这些问题，并没有严格的标准答案——一切由开发者决定。某种意义上讲，这样的状况类似在GPU上编写可编程的着色器：开发者决定软件如何利用硬件提供的基本计算能力。

为了辅助说明在选择追迹哪些光线时做的权衡，我们通过蒙特卡洛积分，从一个基本的环境光遮蔽计算开始。读者会看到不同的采样技术（追踪光线选择不同）会带来不同的误差。后面我们会利用这些概念去采样面光源的直接光照。

怎样的采样才是优秀的？这一话题十分复杂，无数的专著加以解释，而相关领域研究直到今天依然是开放的。限于篇幅，本章仅仅能介绍一点皮毛，但也提供了足够的信息资源引导读者深入下去。

## 15.2	例子：环境光遮蔽
绝大多数有关光照、反射、图形的计算都可以理解为积分问题：举例来说，计算表面的反射光，要积分方向半球空间中所有入射到空间中一点的光能量和该点双向散射分布函数（BSDF）的乘积。

在渲染领域，*蒙特卡洛积分*是一种行之有效的方法。这是一种基于对被积函数做加权采样的统计方法。蒙特卡洛用于渲染的优越性在于，它能很好地应对高维积分（本文结尾的全局光照需要高维积分），对被积函数没有太多限制，计算也仅仅需要逐点去求被积函数的值。相关的介绍可以在Sobol[5]的文章找到。

采样再适合光线追踪不过了，采样直接面对光线追踪所必要的查询，例如“光源从该方向可见吗？”或者“沿该方向第一个可见表面是什么？”
下面是$k$个样本的基本蒙特卡洛求值器的定义，可以计算函数$f$的$n$维积分的估计值：

$$  
E[\frac{1}{k}\sum_{i=1}^kf(X_i)]= \int_{[0,1]^n}f(x)dx.\tag{15.1}  
$$  


等式的左侧*E*表示*期望值*，统计上来说，方括号内的期望值应该等于等式右边。期望值可能偏大或偏小，随着更多采样的加入，期望值的结果逐渐收敛。

方括号内，表示的是利用一组在$[0,1)^n$均匀采样的独立随机变量$X_i$计算的函数$f$的平均值。在蒙特卡洛估计函数中，每个$X_i$实质是一个n维的随机数，写成随机变量的形式便于更严密地讨论期望。

下面把蒙特卡罗方法用于环境光遮蔽的计算。环境光遮蔽作为一种有用的着色技术，能模拟一部分全局光照效果。定义$P$点的环境光遮蔽函数$a$

$$a(P)=\frac{1}{π}\int_{Ω}v_d(ω)\cosθdω,\tag{15.2}$$

$v_d$是可见函数，如果光线从$P$出发，沿$ω$方向传播距离$d$时，途中遇到遮挡物，值为0。否则值为1。$Ω$表示围绕$P$点表面法线的方向半球，$θ$是关于表面法线的夹角。$\frac{1}{π}$确保$a(P)$的值位于0和1之间。

现在把蒙特卡洛估计函数用于*环境光遮蔽*。在半球域积分而不是$[0,1)^n$。通过改变变量，估计函数也能用于其他的积分定义域。估计函数最后写作

$$a(P)=E[\frac{1}{k}\sum_{i=1}^k\frac{1}{π}v_d(ω_i)\cosθ_i],\tag{15.3}$$

$ω_i$是半球空间内按照均匀概率密度随机选取的方向。

下面的算法可以在半球空间内按均匀采样生成随机方向。给定$[0,1)$范围的随机数$ξ_1$和$ξ_2$，按照(15.4)式计算即可得到围绕(0,0,1)的半球空间方向取样（经过坐标变换，表面法线方向要和z轴对准）：

$$(x,y,z)=(\sqrt{1-ξ_1^2}\cos(2πξ_2),\sqrt{1-ξ_1^2}\sin(2πξ_2),ξ_1)\tag{15.4}$$


```
图15.1	带环境光遮蔽渲染的皇冠模型。左图：我们每个像素用4条光线追踪，以物体表面可见点为中心做半球，光线方向在半球空间中均匀分布。右图：参考图像，已经收敛的用2048光线/像素渲染的结果。
```

图15.1展示了一个带环境光遮蔽的皇冠模型，每个像素仅仅使用4条光线采样计算。光线数很少，也没有额外的降噪操作，图像显得噪声很重，不过仍然是向着正确的方向发展的。

另一种蒙特卡洛估计函数，允许按照不均匀的概率密度分布函数采样随机样本。定义如下：

$$E[\frac{1}{k}\sum_{i=1}^k\frac{f(X_i)}{p(X_i)}]=\int_{[0,1]^n}f(x)dx.\tag{15.5}$$

现在独立随机变量$X_i$服从不均匀的概率密度分布函数$p(x)$。通过除以$p(x)$，一切都显得很清楚了。当我们更希望在积分定义域的某些部分采样时，$p(x)$的值比较大，这些样本的贡献要相对减少。反过来，如果样本的取样概率低于均匀采样，这些样本的贡献应当更大，因为$p(x)$很小。不允许样本的概率为0。

我们为什么考虑不均匀采样呢？回到环境光遮蔽的问题。给出在半球空间按照余弦分布的采样公式（中心法线依然是(0,0,1)）:

$$(x,y,z)=(\sqrt{ξ_1}\cos{2πξ_2},\sqrt{ξ_1}\sin{2πξ_2},\sqrt{1-ξ_1}).\tag{15.6}$$

同样的，$ξ_1$和$ξ_2$是$[0,1)$范围内的相互独立的两个随机数。余弦分布的$p(ω)=\cos{θ}/π$,π是用于归一化的常数。

根据上面推导的式子，得出余弦分布样本$ω_i$的环境光遮蔽估计函数：

$$a(P)=E[\frac{1}{k}\sum_{i=1}^k\frac{1}{π}\frac{v(ω_i)\cos(θ_i)}{\cos(θ_i)/π}]=E[\frac{1}{k}\sum_{i=1}^kv(ω_i)].\tag{15.7}$$


按照正比于$\cosθ$的概率生成光线，因此余弦的部分相消。实际上，采样的光源对估计结果的贡献要么0，要么1[^1]。

算法实现如下：


^1:如果读者已经基于屏幕实现了环境光遮蔽，那么您已经在使用这里提到的方法，现在更容易理解这样做的价值。


    图15.2	环境光遮蔽渲染的皇冠模型：左图均匀采样，右图余弦加权采样。均使用4光线/像素。余弦采样相比平均采样降低了接近30%的误差。图像上肉眼可见的噪声减少。

```c
float ao(float3 p, float3 n, int nSamples){

}
```
图15.2再一次展示了皇冠模型。现在比较均匀采样和余弦采样，余弦采样的误差明显更低，Why？

使用均匀采样，一部分光线对结果贡献很小，利用掠射表面，接近水平的光线，其余弦值接近0，因此追踪这种光线获得的收益很小。其对求和估计函数的贡献值，要么0，要么很小。换句话说。尽管花了很多工作量去追踪光线，但是没能得到足够的贡献值。要达到理想的效果，两种采样方法所需的光线数差距是不容忽视的，没有理由不使用更加高效的采样技术。

这一通用的技术，按照接近被积函数的概率分布去采样，称为重要性采样。重要性采样是渲染中蒙特卡洛积分的关键技术，其中概率分布$p(x)$越接近被积函数$f(x)$，效果越好。然而当$p(x)$和$f(x)$差别比较大的时候，$f(x)/p(x)$的值在最小最大值之间剧烈波动，误差依然会上升。尽管理论上，满足对任意$f(x)\neq0$，$p(x)>0$，总会得到正确结果。但是一定采样次数下，误差可能大到毫无意义。

## 15.3	理解方差
蒙特考罗积分使用*方差*的概念量化期望误差。随机变量$X$的方差以期望的形式定义

$$V[X]\equiv E[(X-E[X])^2]=E[X^2]-E[X]^2\tag{15.8}$$

方差测量随便变量和期望之间的平方差。如果随机变量的方差很低，其取值接近平均值（反之则方差很大）。

如果能准确计算随机变量的方差（例如大量样本的蒙特卡洛积分），就可以用(15.8)式计算样本方差。下面的代码阐释了计算过程：

```c
float estimate_sample_variance(float samples[], int n){

}
```
计算方差不需要保留所有样本值，只需要在计算过程中更新随机变量之和跟平方和，以及样本的数量。

样本方差自身也有方差。假设有一些相似的样本，其方差很大。我们仍然能得到一个小的多的样本方差的方差估计。

方差在蒙特卡洛积分中是特别有用的概念，方差和样本数之间存在这样的关系：*对于随机样本，方差随着样本数目增大线性减小*[^2]。因此如果采样两倍的样本，就能把方差降低一半。考虑到方差是平方后的误差，因此要把实际误差砍到一半，采样数要增大为4倍。

^2:特别当被积函数平滑时，方差在特定精心构造的采样模式下降低地更多。这里先不做讨论。

```
图15.3	由于方差随着样本数线性降低，我们能准确估计把测的方差降到一定程度，需要多少样本。左图每像素使用8条均匀采样的光线，右图是4条余弦采样的光线。两张图的方差接近，尽管右图只需要采样左图一般的光线。
```
方差和样本数的关系，能解释光线追踪的很多问题。一方面它帮我们理解采样数从每像素一条光线、两条光线乃至更多时，图像质量提升为何如此快。采样数量很少时，加倍采样很好做，方差因此会砍到一半。

另一方面，这也说明了一味增加采样光线不能解决问题。如果每像素采样128条光线，为了方差减半就要逐像素多采样128条光线。当图像采样密度已经很高，噪声依然很重，继续翻倍采样是不现实的。降噪算法的价值此时体现出来，合理数目的光线追踪实现后，算法去噪比继续增加光线更有效。

我们计算下皇冠所有图像的平均样本方差。环境光遮蔽下的15.2左图，方差为0.0972。15.2右图使用余弦加权采样，方差0.0508。两者比率大概1.91，因此均匀采图把光线数提高到1.91倍，就能得到和右图同样的质量。

图15.3的左图重新用8光线/像素均匀采样，得到了和右图4光线/像素余弦采样类似的结果。图像质量很接近，左图的方差降低到0.0484，略优于余弦采样右图。

方差值可以指导降噪滤波器的尺寸设计：方差很低，不需要多少滤波，反之则需要大尺度的滤波器。上文对样本方差自身的方差估计的描述运用在这里，就是通过空域邻域滤波或者时域多帧平滑来降低方差。

方差估计也用于自适应采样算法，决定不同位置需要的采样密度。如果能挑选出方差比采样数最高的像素，那我们就能充分利用新增采样光线：假定方差随光线数线性递减，把新增的光线尽量布置在所述的像素，这些光线对整张图的方差降低起到显著影响[^3]。

^3:实验表明，基于采样值的自适应采样方法，会导致蒙特卡洛估计函数结果出现偏差[3]。函数值不会收敛到正确的结果（尽管方差下降很快），根本原因在于估算样本方差的误差并非总体的真实误差。

## 15.4	直接光照
表面散射方程是渲染的又一个重要积分方程。方程根据入射亮度函数$L_i(P,ω)$和BSDF函数$f(ω\rightarrow ω_o)$给出P点沿$ω_o$方向的散射亮度：

$$L_o(P,ω_o)=\int_Ω L_i(P,ω)f(ω\rightarrow ω_o)\cos(θ)dω.\tag{15.9}$$

本节用几种不同的采样方式估计积分值，并且通过方差评价渲染效果。

根据15.2节最后讨论的，方向概率分布函数，应该正比于$L_i$,$f$和$\cos{θ}$的乘积。理论上可以，操作中难以实现。入射亮度函数本身没有近似的函数表达式，需要通过追踪光线去估算。

这里做一些简化。首先认为入射光是从光源出射，忽略间接光照。其次，只关注正比于$L_i$的采样函数。第二点简化不能用于实际光追设计，根据BSDF采样并通过多重重要性采样平衡光源采样和表面采样的权重是很有必要的[6]。

按照上述简化，要计算下面的蒙特卡洛估计函数：

$$L_o(P,ω_o)=E[\frac{1}{k}\sum_{i=1}^{k}\frac{L_i(P,ω_i)f(ω_i\rightarrow ω_o)\cos{θ_i}}{p(ω_i)}],\tag{15.10}$$

$ω_i$按照概率密度分布函数$p(ω)$采样。只考虑直接光照的时候，没必要采样路径上不与光源相交的方向。基于上述讨论，采用的策略是，按照某种分布在光源表面采样，选择光源上一点，方向$ω_i$是物体表面点P到光源采样点的连线。


```c
图15.4 采样黄色圆表示的球形光源时，至少有一半的球因为遮挡，不能从P点看到。均匀地在球面采样十分低效，球背面的采样点全部被遮挡。
```
对球面光源来说，给出下面的算法。取一组独立均匀采样的随机数$ξ_1$和$ξ_2$，当单位球中心位于原点时，采样点坐标为：

$$z=1-2ξ_1,x=\sqrt{1-z^2}\cos{2πξ_2},y=\sqrt{1-z^2}\sin{2πξ_2}\tag{15.11}$$

图15.4在二维尺度上展示了该方法。很显然的问题在于，一半的采样点对P点不可见，完全浪费了采样光线。类似的问题在三维尺度也是存在的。

更优越的一种采样策略是，以点P作为顶点，建立圆锥体包围光源球，在锥体内均匀采样，选择光源的表面采样点。这样确保所有的光源采样点都对P点可见（尽管仍然可能被空间其他物体遮挡）。圆锥体关于圆锥半顶角$θ$的均匀采样算法在16章，“采样变换集合”中会给出。在这里重复一遍：

$$\cos{θ'}=(1-ξ_1)+ξ_1\cos(θ),Φ=2πξ_2\tag{15.12}$$

$θ'$是采样方向关于圆锥旋转轴的夹角，范围$[0,θ)$,$Φ$是0到2π之间描述围绕旋转轴旋转大小的值。图15.5阐述了该方法。

改善的采样方法带来的区别很明显，渲染结果如图15.6所示。按照4光线/像素的采样密度，均匀球面采样的结果平均像素方差为0.0787。而锥体采样的方差为0.0248，只有前者的1/3。正如在环境光遮蔽一节的讨论，均匀采样要达到锥体采样的效果，光线数要增大到3倍以上。


```
图15.5	从P到P’为旋转轴，建立圆锥恰好包围光源球面，其半顶角为θ。如果在锥角范围内均匀采样方向，选取的黑色光源采样点对P点都可见。
```
分析过一个球形光源如何采样后，作为最后一个例子，当场景中存在多个光源时，我们要说明选择哪个光源采样，同样影响计算的方差值。

WhiteRoom场景中设置两个光源，自然的选择是光线数目平分，分别追踪到两个光源。考虑一个靠近某个光源的物体，例如落地灯的右墙，天花板吊灯对右墙的照明远远不及旁边的落地灯。也就是说，吊灯对右墙的光照贡献不如靠近的落地灯。这样的情形和前面讨论环境光遮蔽时的掠射光如出一辙。

通过把光线传播距离和光源能量引入采样概率分布函数，选择的光线更为高效，图像方差有效降低[^4]。图15.7展示了渲染结果。把光源贡献引入采样概率分布，图像质量进一步提升，平均方差0.00921，相比锥体采样的方差0.0248降低了60%以上。两种方法合计降低方差达85%以上。

^4:请阅读Conty Estevez和Kulla的文章[1]，描述了我们这里使用的算法。还有第18章，“GPU实现的多光源重要性采样”。这一问题会详细讨论。
```
图15.6 夜晚的WhiteRoom，包括两个球形光源，按照4光线/像素的比例渲染。上图：球形灯均匀采样。下图：球形光源在照明锥角范围内均匀采样。同样数目光线，上图方差是下图的3.1倍。下图的采样方法更为优越。（场景由JayHardy在CC-BY协议下提供）
```

```
图15.7	夜晚的WhiteRoom，比较两种光源选择的采样策略。上图，两个光源按照相同概率采样。下图，光源按正比于光照经表面反射贡献值的概率采样。通过后者的技术，方差降低了60%以上。（场景由JayHardy在CC-BY协议下提供）
```

##	15.5 Conclusion
本章试图让读者对重要性采样有基本的理解。更重要的是，理解为什么要改善采样方法。朴素的低效率采样很容易，而高效的采样也没有想象中难。在我们的例子中，由于采样策略的改善和采样光线数增加，方差降低了50%~85%。

给定方差和采样数目的关系，另一种看法是，如果不调整采样，GPU设备只能运行在提供性能的1/8到1/2水平。

本章仅仅指出了光线追踪采样的皮毛，我们没有讨论如何按照BSDF采样或者如何应用多重重要性采样技术。请关注第28章“光线追踪不均匀介质”；第18章“GPU实现的多光源重要性采样”；第16章“采样变换集合”，这些章节会给出深入的答案。本文没有讨论通过更均匀地样本分布设计以降低后续误差的方法，Keller的综述[2]会给出说明。有关上述问题也可以关注“物理渲染”[4]一书，目前在网络上免费阅读。
